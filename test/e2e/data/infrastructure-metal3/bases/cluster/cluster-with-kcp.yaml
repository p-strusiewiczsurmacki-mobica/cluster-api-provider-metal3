# apiVersion: cluster.x-k8s.io/${CAPI_VERSION}
# kind: Cluster
# metadata:
#   labels:
#     cni: ${CLUSTER_NAME}-crs-0
#   name: ${CLUSTER_NAME}
#   namespace: ${NAMESPACE}
# spec:
#   clusterNetwork:
#     pods:
#       cidrBlocks: ["${POD_CIDR}"]
#     services:
#       cidrBlocks: ["${SERVICE_CIDR}"]
#   controlPlaneRef:
#     apiVersion: controlplane.cluster.x-k8s.io/${CAPI_VERSION}
#     kind: KubeadmControlPlane
#     name: ${CLUSTER_NAME}
#   infrastructureRef:
#     apiVersion: infrastructure.cluster.x-k8s.io/${CAPM3_VERSION}
#     kind: Metal3Cluster
#     name: ${CLUSTER_NAME}
# ---
apiVersion: infrastructure.cluster.x-k8s.io/${CAPM3_VERSION}
kind: Metal3ClusterTemplate
metadata:
  name: ${CLUSTER_NAME}
  namespace: ${NAMESPACE}
spec:
  controlPlaneEndpoint:
    host: ${CLUSTER_APIENDPOINT_HOST}
    port: ${CLUSTER_APIENDPOINT_PORT}
  noCloudProvider: true
---
apiVersion: controlplane.cluster.x-k8s.io/${CAPI_VERSION}
kind: KubeadmControlPlane
metadata:
  name: ${CLUSTER_NAME}
  namespace: ${NAMESPACE}
spec:
  machineTemplate:
    nodeDrainTimeout: ${NODE_DRAIN_TIMEOUT}
    infrastructureRef:
      apiVersion: infrastructure.cluster.x-k8s.io/${CAPM3_VERSION}
      kind: Metal3MachineTemplate
      name: ${CLUSTER_NAME}-controlplane
  kubeadmConfigSpec:
    clusterConfiguration: {}
    users:
    - name: ${IMAGE_USERNAME}
      sshAuthorizedKeys:
      - ${SSH_PUB_KEY_CONTENT}
      sudo: ALL=(ALL) NOPASSWD:ALL
  replicas: ${CONTROL_PLANE_MACHINE_COUNT}
  rolloutStrategy:
    rollingUpdate:
      maxSurge: 1
  version: ${KUBERNETES_VERSION}
---
apiVersion: infrastructure.cluster.x-k8s.io/${CAPM3_VERSION}
kind: Metal3MachineTemplate
metadata:
  name: ${CLUSTER_NAME}-controlplane
  namespace: ${NAMESPACE}
spec:
  template:
    spec:
      dataTemplate:
        name: ${CLUSTER_NAME}-controlplane-template
      image:
        checksum: ${IMAGE_RAW_CHECKSUM}
        checksumType: ${IMAGE_CHECKSUM_TYPE}
        format: raw
        url: ${IMAGE_RAW_URL}
---
apiVersion: infrastructure.cluster.x-k8s.io/${CAPM3_VERSION}
kind: Metal3DataTemplate
metadata:
  name: ${CLUSTER_NAME}-controlplane-template
  namespace: ${NAMESPACE}
spec:
  clusterName: ${CLUSTER_NAME}
  metaData:
    ipAddressesFromIPPool:
    - key: provisioningIP
      name: provisioning-pool
    objectNames:
    - key: name
      object: machine
    - key: local-hostname
      object: machine
    - key: local_hostname
      object: machine
    prefixesFromIPPool:
    - key: provisioningCIDR
      name: provisioning-pool
  networkData:
    links:
      ethernets:
      - id: enp1s0
        macAddress:
          fromHostInterface: enp1s0
        type: phy
      - id: enp2s0
        macAddress:
          fromHostInterface: enp2s0
        type: phy
    networks:
      ipv4:
      - id: baremetalv4
        ipAddressFromIPPool: baremetalv4-pool
        link: enp2s0
        routes:
        - gateway:
            fromIPPool: baremetalv4-pool
          network: 0.0.0.0
          prefix: 0
    services:
      dns:
      - 8.8.8.8
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: ClusterClass
metadata:
  name: example-clusterclass
spec:
  variables:
  - name: controlPlaneEndpoint
    required: true
    schema:
      openAPIV3Schema:
        type: object
        properties: 
          host: 
            type: string
          port:
            type: integer
  - name: image
    schema:
      openAPIV3Schema:
        type: object
        properties: 
          checksum: 
            type: string
          checksumType:
            type: string
          format:
            type: string
          url:
            type: string
  - name: workerDataTemplate
    schema:
      openAPIV3Schema:
        type: string
  - name: controlPlaneDataTemplate
    schema:
      openAPIV3Schema:
        type: string
  patches:
  - name: controlPlaneEndpointSub
    description: Overrides controlPlaneEndpoint data of Metal3ClusterTemplate used by the cluster
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: Metal3ClusterTemplate
        matchResources:
          infrastructureCluster: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/controlPlaneEndpoint
        valueFrom:
          variable: controlPlaneEndpoint
  - name: imageSub
    description: Overrides image data for worker nodes of example-worker class
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: Metal3MachineTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - example-worker
      jsonPatches:
      - op: replace
        path: /spec/template/spec/image/checksum
        valueFrom:
          variable: image.checksum
      - op: replace
        path: /spec/template/spec/image/checksumType
        valueFrom:
          variable: image.checksumType
      - op: replace
        path: /spec/template/spec/image/format
        valueFrom:
          variable: image.format
      - op: replace
        path: /spec/template/spec/image/url
        valueFrom:
          variable: image.url
  - name: workerDataTemplateSub
    description: Overrides data-template for worker nodes
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: Metal3MachineTemplate
        matchResources:
          machineDeploymentClass:
            names:
            - example-worker
      jsonPatches:
      - op: replace
        path: /spec/template/spec/dataTemplate/name
        valueFrom:
          variable: workerDataTemplate
  - name: controlPlaneImageSub
    description: Overrides image data for worker nodes of control plane node
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: Metal3MachineTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/image/checksum
        valueFrom:
          variable: image.checksum
      - op: replace
        path: /spec/template/spec/image/checksumType
        valueFrom:
          variable: image.checksumType
      - op: replace
        path: /spec/template/spec/image/format
        valueFrom:
          variable: image.format
      - op: replace
        path: /spec/template/spec/image/url
        valueFrom:
          variable: image.url
  - name: controlPlaneDataTemplateSub
    description: Overrides data-template for control plane nodes
    definitions:
    - selector:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: Metal3MachineTemplate
        matchResources:
          controlPlane: true
      jsonPatches:
      - op: replace
        path: /spec/template/spec/dataTemplate/name
        valueFrom:
          variable: controlPlaneDataTemplate
  controlPlane:
    ref:
      apiVersion: controlplane.cluster.x-k8s.io/v1beta1
      kind: KubeadmControlPlaneTemplate
      name: ${CLUSTER_NAME}
    machineInfrastructure:
      ref:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
        kind: Metal3MachineTemplate
        name: ${CLUSTER_NAME}-controlplane
  workers:
    machineDeployments:
    - class: worker
      template:
        metadata:
          labels:
            cluster.x-k8s.io/cluster-name: ${CLUSTER_NAME}
            nodepool: nodepool-0
        bootstrap:
          ref:
            apiVersion: bootstrap.cluster.x-k8s.io/${CAPI_VERSION}
            kind: KubeadmConfigTemplate
            name: ${CLUSTER_NAME}-workers
        infrastructure:
          ref:
            apiVersion: infrastructure.cluster.x-k8s.io/${CAPM3_VERSION}
            kind: Metal3MachineTemplate
            name: ${CLUSTER_NAME}-workers
  infrastructure:
    ref:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
      kind: Metal3ClusterTemplate
      name: ${CLUSTER_NAME}
---
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
    labels:
      cni: ${CLUSTER_NAME}-crs-0
    name: ${CLUSTER_NAME}
    namespace: ${NAMESPACE}
spec:
  topology:
    class: example-clusterclass
    version: ${KUBERNETES_VERSION}
    controlPlane:
      replicas: 1
    workers:
      machineDeployments:
      - class: worker
        name: ${CLUSTER_NAME}-machine
        replicas: 1
    variables:
    - name: image
      value:
        checksum: ${IMAGE_CHECKSUM}
        checksumType: ${IMAGE_CHECKSUM_TYPE}
        format: ${IMAGE_FORMAT}
        url: ${IMAGE_URL}
    - name: controlPlaneEndpoint
      value:
        host: ${CLUSTER_APIENDPOINT_HOST}
        port: ${CLUSTER_APIENDPOINT_PORT}
    - name: workerDataTemplate
      value: example-md-metadata
    - name: controlPlaneDataTemplate
      value: example-cp-metadata